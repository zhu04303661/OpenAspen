# OpenAspen

OpenAspen的开源实现 -基于大模型Agent技术和机理模型，重新实现现代化化工过程仿真平台

## 📋 项目概述

项目是对DWSIM5 (.NET)的完整Python重新实现，保持了原有的核心架构设计，同时提供了现代化的RESTful API服务接口。本项目旨在为化工过程仿真提供一个高性能、易扩展的Python解决方案。

## ✨ 主要特性

- **🏗️ 六层架构设计**: 保持DWSIM5原有的分层架构，确保系统稳定性和可维护性
- **🚀 高性能计算**: 基于NumPy、SciPy和CoolProp的科学计算栈
- **🌐 RESTful API**: 现代化的Web API接口，支持多种编程语言调用
- **📦 模块化设计**: 高度解耦的模块架构，易于扩展和维护
- **🔬 丰富的物性包**: 支持PR、SRK、UNIFAC、NRTL等主流热力学模型
- **⚡ 并行计算**: 支持异步处理和并发计算
- **🐳 容器化部署**: 完整的Docker支持，易于部署和扩展
- **🔄 流程图求解**: 完整的FlowsheetSolver实现，支持复杂流程计算

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            OpenAspen 系统架构                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                               API服务层 (dwsim_api)                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────────┐ │
│  │   RESTful API       │   │   WebSocket API     │   │    GraphQL API         │ │
│  │   (FastAPI)         │   │   (实时计算)        │   │    (复杂查询)          │ │
│  │                     │   │                     │   │                         │ │
│  │ • 物性计算 API      │   │ • 实时监控          │   │ • 灵活数据查询          │ │
│  │ • 闪蒸计算 API      │   │ • 计算进度推送      │   │ • 批量操作              │ │
│  │ • 流程图 API        │   │ • 异常通知          │   │ • 复杂关联查询          │ │
│  │ • 组分管理 API      │   │ • 结果推送          │   │ • 数据聚合              │ │
│  └─────────────────────┘   └─────────────────────┘   └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │                            
                              ▼                            
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           业务逻辑层 (dwsim_operations)                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────────┐ │
│  │   FlowsheetSolver   │   │   UnitOperations    │   │   Optimization         │ │
│  │   (流程图求解器)    │   │   (单元操作)        │   │   (优化算法)            │ │
│  │                     │   │                     │   │                         │ │
│  │ • 拓扑排序          │   │ • 闪蒸器            │   │ • 遗传算法              │ │
│  │ • 依赖解析          │   │ • 精馏塔            │   │ • 粒子群优化            │ │
│  │ • 收敛检查          │   │ • 换热器            │   │ • 序列二次规划          │ │
│  │ • 循环求解          │   │ • 反应器            │   │ • 多目标优化            │ │
│  │ • 并行计算          │   │ • 压缩机            │   │ • 敏感性分析            │ │
│  │ • 远程求解          │   │ • 泵类设备          │   │ • 参数估计              │ │
│  └─────────────────────┘   └─────────────────────┘   └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │                            
                              ▼                            
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           计算引擎层 (dwsim_thermo)                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────────┐ │
│  │   PropertyPackages  │   │   FlashAlgorithms   │   │   NumericalSolvers     │ │
│  │   (物性包)          │   │   (闪蒸算法)        │   │   (数值求解器)          │ │
│  │                     │   │                     │   │                         │ │
│  │ • Peng-Robinson     │   │ • PT闪蒸            │   │ • Newton-Raphson        │ │
│  │ • SRK状态方程       │   │ • PH闪蒸            │   │ • Broyden方法           │ │
│  │ • UNIFAC模型        │   │ • PS闪蒸            │   │ • 逐次替代法            │ │
│  │ • NRTL模型          │   │ • 三相闪蒸          │   │ • Gibbs最小化           │ │
│  │ • CoolProp接口      │   │ • 电解质闪蒸        │   │ • 优化算法              │ │
│  │ • 蒸汽表            │   │ • 固液平衡          │   │ • 线性代数求解          │ │
│  └─────────────────────┘   └─────────────────────┘   └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │                            
                              ▼                            
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           数据访问层 (dwsim_data)                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────────┐ │
│  │   ComponentDB       │   │   InteractionParams │   │   DataLoaders          │ │
│  │   (组分数据库)      │   │   (交互参数)        │   │   (数据加载器)          │ │
│  │                     │   │                     │   │                         │ │
│  │ • DWSIM数据库       │   │ • UNIFAC参数        │   │ • JSON加载器            │ │
│  │ • ChemSep数据库     │   │ • NRTL参数          │   │ • XML加载器             │ │
│  │ • CoolProp数据库    │   │ • PR-kij参数        │   │ • 文本加载器            │ │
│  │ • 用户自定义数据    │   │ • SRK-kij参数       │   │ • 数据库连接器          │ │
│  │ • 在线数据源        │   │ • 活度系数参数      │   │ • 缓存管理器            │ │
│  └─────────────────────┘   └─────────────────────┘   └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                              │                            
                              ▼                            
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           核心架构层 (dwsim_core)                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────────┐ │
│  │   Interfaces        │   │   Exceptions        │   │   Utilities            │ │
│  │   (接口定义)        │   │   (异常处理)        │   │   (工具类)              │ │
│  │                     │   │                     │   │                         │ │
│  │ • IComponent        │   │ • ThermoErrors      │   │ • UnitConverter         │ │
│  │ • IStream           │   │ • ConvergenceErrors │   │ • PhysicalConstants     │ │
│  │ • IPropertyPackage  │   │ • ParameterErrors   │   │ • MathUtils             │ │
│  │ • IUnitOperation    │   │ • NetworkErrors     │   │ • StringUtils           │ │
│  │ • IFlashAlgorithm   │   │ • DataErrors        │   │ • FileUtils             │ │
│  │ • ISolver           │   │ • TimeoutErrors     │   │ • ConfigManager         │ │
│  └─────────────────────┘   └─────────────────────┘   └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              跨层支持组件                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────────┐ │
│  │   EventSystem       │   │   ErrorHandler      │   │    Diagnostics         │ │
│  │   (事件系统)        │   │   (错误处理器)      │   │    (诊断系统)          │ │
│  │                     │   │                     │   │                         │ │
│  │ • 事件发布          │   │ • 异常捕获          │   │ • 性能监控              │ │
│  │ • 生命周期跟踪      │   │ • 错误恢复          │   │ • 日志记录              │ │
│  │ • 脚本触发          │   │ • 用户通知          │   │ • 调试信息              │ │
│  └─────────────────────┘   └─────────────────────┘   └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🚀 快速开始

### 环境要求

- Python 3.8+
- pip 或 conda

### 安装依赖

```bash
# 克隆项目
git clone <repository-url>
cd dwsim-python

# 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或者
venv\Scripts\activate     # Windows

# 安装依赖
pip install -r requirements.txt

# 开发环境安装
pip install -e ".[dev,database,cache]"
```

### 运行API服务

```bash
# 启动开发服务器
cd dwsim_api
python main.py

# 或使用uvicorn
uvicorn dwsim_api.main:app --reload --host 0.0.0.0 --port 8000
```

访问 http://localhost:8000/docs 查看API文档

### 基本使用示例

```python
import requests

# 计算纯组分物性
response = requests.post("http://localhost:8000/api/v1/properties/component", json={
    "component": "Methane",
    "temperature": 298.15,  # K
    "pressure": 101325,     # Pa
    "property_types": ["density", "viscosity"],
    "property_package": "Peng-Robinson"
})

print(response.json())

# PT闪蒸计算
response = requests.post("http://localhost:8000/api/v1/flash/pt-flash", json={
    "composition": {"Methane": 0.7, "Ethane": 0.3},
    "specification_1": {"type": "temperature", "value": 250.0},
    "specification_2": {"type": "pressure", "value": 2000000},
    "property_package": "Peng-Robinson"
})

print(response.json())
```

## 📊 支持的功能

### 🔬 热力学模型

#### 状态方程物性包

| 模型类型      | 实现状态 | 描述                         | 适用范围 |
| ------------- | -------- | ---------------------------- | -------- |
| Peng-Robinson | ✅       | 立方状态方程，适用于轻烃系统 | 油气工业 |
| SRK           | ✅       | Soave-Redlich-Kwong状态方程  | 石化工业 |
| Lee-Kesler    | 🚧       | 基于临界性质的状态方程       | 重烃系统 |

#### 活度系数模型

| 模型类型      | 实现状态 | 描述                         | 适用范围 |
| ------------- | -------- | ---------------------------- | -------- |
| UNIFAC        | 🚧       | 基团贡献法活度系数模型       | 有机混合物 |
| NRTL          | 🚧       | 非随机双液体模型             | 液液平衡 |
| UNIQUAC       | 🚧       | 通用准化学活度系数模型       | 复杂混合物 |
| Wilson        | 🚧       | Wilson活度系数模型           | 极性系统 |

#### 特殊物性包

| 模型类型      | 实现状态 | 描述                         | 适用范围 |
| ------------- | -------- | ---------------------------- | -------- |
| CoolProp      | ✅       | 高精度物性数据库接口         | 1900+组分 |
| 蒸汽表        | 🚧       | IAPWS-IF97水蒸汽物性         | 电力工业 |
| 理想气体      | ✅       | 理想气体状态方程             | 高温低压 |

### ⚡ 闪蒸算法

| 算法类型      | 实现状态 | 描述                         | 应用场景 |
| ------------- | -------- | ---------------------------- | -------- |
| PT闪蒸        | ✅       | 温度-压力闪蒸                | 基础分离 |
| PH闪蒸        | 🚧       | 压力-焓闪蒸                  | 节流过程 |
| PS闪蒸        | 🚧       | 压力-熵闪蒸                  | 压缩过程 |
| TV闪蒸        | 🚧       | 温度-体积闪蒸                | 定容过程 |
| 三相闪蒸      | 🚧       | 气-液-液三相平衡             | 复杂系统 |
| 电解质闪蒸    | 🚧       | 离子系统相平衡               | 电解质溶液 |

### 🏭 单元操作

#### 分离设备

| 设备类型      | 实现状态 | 描述                         | 功能特点 |
| ------------- | -------- | ---------------------------- | -------- |
| 闪蒸器        | ✅       | 单级气液分离                 | PT/PH闪蒸 |
| 精馏塔        | 🚧       | 多级精馏分离                 | 理论板/填料 |
| 吸收塔        | 🚧       | 气液吸收过程                 | 逐板计算 |
| 萃取塔        | 🚧       | 液液萃取分离                 | 多级接触 |

#### 换热设备

| 设备类型      | 实现状态 | 描述                         | 功能特点 |
| ------------- | -------- | ---------------------------- | -------- |
| 换热器        | 🚧       | 流体间热量交换               | 传热计算 |
| 加热器        | 🚧       | 加热升温过程                 | 定温/定热量 |
| 冷却器        | 🚧       | 冷却降温过程                 | 冷却介质 |
| 冷凝器        | 🚧       | 蒸汽冷凝过程                 | 相变传热 |

#### 反应设备

| 设备类型      | 实现状态 | 描述                         | 功能特点 |
| ------------- | -------- | ---------------------------- | -------- |
| 连续搅拌反应器| 🚧       | CSTR反应器模型               | 动力学计算 |
| 平推流反应器  | 🚧       | PFR反应器模型                | 微分方程 |
| 平衡反应器    | 🚧       | 化学平衡计算                 | 平衡常数 |

#### 动力设备

| 设备类型      | 实现状态 | 描述                         | 功能特点 |
| ------------- | -------- | ---------------------------- | -------- |
| 离心泵        | 🚧       | 液体输送设备                 | 扬程计算 |
| 压缩机        | 🚧       | 气体压缩设备                 | 功耗计算 |
| 膨胀机        | 🚧       | 气体膨胀设备                 | 功率回收 |

### 🧮 数值求解器

| 求解器类型    | 实现状态 | 描述                         | 应用范围 |
| ------------- | -------- | ---------------------------- | -------- |
| Newton-Raphson| ✅       | 牛顿法非线性方程求解         | 快速收敛 |
| Broyden方法   | ✅       | 拟牛顿法求解                 | 无需雅可比 |
| 逐次替代法    | ✅       | 简单迭代法                   | 稳定收敛 |
| 线性代数求解  | ✅       | 线性方程组求解               | 基础算法 |
| 优化算法      | 🚧       | 多目标优化                   | 工艺优化 |

### 🔄 流程图求解器

| 功能模块      | 实现状态 | 描述                         | 技术特点 |
| ------------- | -------- | ---------------------------- | -------- |
| 拓扑排序      | ✅       | 计算顺序确定                 | Kahn算法 |
| 依赖解析      | ✅       | 对象依赖关系分析             | 图论算法 |
| 循环求解      | ✅       | 循环流程收敛                 | Broyden加速 |
| 并行计算      | ✅       | 多线程并行处理               | TaskScheduler |
| 远程求解      | 🚧       | 分布式计算支持               | TCP/云计算 |
| 异常处理      | ✅       | 计算异常恢复                 | 错误处理 |

## 🧪 测试

```bash
# 运行所有测试
pytest

# 分类测试
pytest tests/unit/ -v          # 单元测试
pytest tests/integration/ -v   # 集成测试
pytest tests/performance/ -v   # 性能测试

# 查看测试覆盖率
pytest --cov=dwsim_core --cov=dwsim_thermo --cov-report=html

# 运行基准测试
pytest tests/benchmarks/ -v
```

## 📖 API文档

### 组分管理

```bash
# 获取所有组分
GET /api/v1/components/

# 搜索组分
GET /api/v1/components/search?keyword=methane

# 获取组分详情
GET /api/v1/components/{component_name}
```

### 物性计算

```bash
# 纯组分物性计算
POST /api/v1/properties/component

# 混合物物性计算
POST /api/v1/properties/mixture

# 获取可用物性包
GET /api/v1/properties/available-packages
```

### 闪蒸计算

```bash
# PT闪蒸
POST /api/v1/flash/pt-flash

# PH闪蒸
POST /api/v1/flash/ph-flash

# 获取可用闪蒸类型
GET /api/v1/flash/available-flash-types
```

### 流程图求解

```bash
# 创建流程图
POST /api/v1/flowsheet/create

# 求解流程图
POST /api/v1/flowsheet/solve

# 获取求解状态
GET /api/v1/flowsheet/{flowsheet_id}/status
```

## 🐳 Docker部署

```bash
# 构建镜像
docker build -t dwsim-python .

# 运行容器
docker run -p 8000:8000 dwsim-python

# 使用docker-compose
docker-compose up -d
```

## 🛠️ 开发指南

### 代码风格

本项目使用以下工具确保代码质量：

```bash
# 代码格式化
black .

# 代码检查
flake8 .

# 类型检查
mypy .
```

### 添加新的物性包

1. 在 `dwsim_thermo/property_packages/` 下创建新的物性包类
2. 继承 `BasePropertyPackage` 基类
3. 实现必要的抽象方法
4. 添加相应的测试用例

### 添加新的单元操作

1. 在 `dwsim_operations/unit_operations/` 下创建新的单元操作类
2. 继承 `IUnitOperation` 接口
3. 实现计算逻辑
4. 添加API接口（可选）

## 📝 性能基准

基于Intel i7-10700K, 32GB RAM的测试结果：

| 操作              | 平均耗时 | 内存使用 | 备注 |
| ----------------- | -------- | -------- | ---- |
| PT闪蒸 (2组分)    | ~5ms     | <10MB    | PR状态方程 |
| 物性计算 (纯组分) | ~1ms     | <5MB     | CoolProp |
| 数据库查询        | ~0.1ms   | <1MB     | 内存缓存 |
| 流程图求解 (50对象)| ~100ms   | <50MB    | 并行计算 |

## 🗺️ 开发路线图

### v1.0.0 (当前) - 核心基础

- ✅ 六层架构实现
- ✅ 基础物性包 (PR, SRK, CoolProp)
- ✅ PT闪蒸算法
- ✅ RESTful API
- ✅ 流程图求解器基础框架
- ✅ 单元测试框架

### v1.1.0 (规划中) - 热力学增强

- 🚧 活度系数模型 (UNIFAC, NRTL, UNIQUAC)
- 🚧 更多闪蒸算法 (PH, PS, TV)
- 🚧 三相闪蒸算法
- 🚧 蒸汽表物性包
- 🚧 基础单元操作实现

### v1.2.0 (规划中) - 单元操作

- 🔮 精馏塔设计
- 🔮 换热器网络
- 🔮 反应器模型
- 🔮 分离设备
- 🔮 动力设备

### v2.0.0 (未来) - 高级功能

- 🔮 图形界面集成
- 🔮 工艺优化算法
- 🔮 敏感性分析
- 🔮 不确定性分析
- 🔮 机器学习集成

### v2.1.0 (未来) - 企业功能

- 🔮 多用户支持
- 🔮 权限管理
- 🔮 云端部署
- 🔮 数据分析平台
- 🔮 报告生成

## 🤝 贡献指南

我们欢迎各种形式的贡献！

1. Fork 项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建 Pull Request

### 贡献类型

- 🐛 Bug 修复
- ✨ 新功能开发
- 📚 文档改进
- 🧪 测试用例添加
- 🎨 代码重构
- ⚡ 性能优化

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 🙏 致谢

- DWSIM项目团队提供的原始架构设计
- CoolProp项目提供的高精度热力学数据
- Python科学计算生态系统的所有贡献者
- FastAPI团队提供的现代Web框架
- NumPy/SciPy团队提供的科学计算基础

## 📞 联系我们

- 项目主页: https://github.com/dwsim-python/dwsim-python
- 问题反馈: https://github.com/dwsim-python/dwsim-python/issues
- 文档站点: https://dwsim-python.readthedocs.io/
- 讨论社区: https://github.com/dwsim-python/dwsim-python/discussions

## 📚 相关资源

- [DWSIM5 原始项目](https://dwsim.org/)
- [CoolProp 物性库](http://www.coolprop.org/)
- [FastAPI 文档](https://fastapi.tiangolo.com/)
- [化工热力学教程](https://dwsim-python.readthedocs.io/tutorials/)
- [API 使用示例](https://github.com/dwsim-python/examples/)
# OpenAspen
